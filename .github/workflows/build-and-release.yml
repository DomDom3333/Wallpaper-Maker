name: Build, Test & Release

# ── Triggers ──────────────────────────────────────────────────────────────────
#
#  • PR targeting main          → test + build only (no publish)
#  • Push to main               → version bump (patch+1) → test + build
#                                 → pre-release vX.Y.Z
#  • Push a tag like v1.2.3     → test + build → versioned release
#
on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

# Allow creating releases and pushing packages
permissions:
  contents: write
  packages: write

env:
  DOTNET_VERSION: '10.0.x'
  AVALONIA_PROJECT: WallpaperMaker.Avalonia/WallpaperMaker.Avalonia.csproj
  DOMAIN_PROJECT:   WallpaperMaker.Domain/WallpaperMaker.Domain.csproj

# ──────────────────────────────────────────────────────────────────────────────
jobs:

  # ── 0. Compute Version ───────────────────────────────────────────────────────
  #
  #  Runs only on push events (not PRs).
  #  • tag push  → uses the pushed tag verbatim (e.g. v1.2.3)
  #  • main push → finds the latest v*.*.* tag in history and bumps the
  #                patch segment by one (e.g. v1.2.3 → v1.2.4).
  #                Falls back to v0.1.0 when no tag exists yet.
  #
  version:
    name: Compute Version
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      tag:        ${{ steps.ver.outputs.tag }}
      semver:     ${{ steps.ver.outputs.semver }}
      title:      ${{ steps.ver.outputs.title }}
      prerelease: ${{ steps.ver.outputs.prerelease }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history so all tags are available

      - name: Compute next version
        id: ver
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            SEMVER="${TAG#v}"
            TITLE="Release ${TAG}"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          else
            # Find the highest existing semver tag and bump the patch number
            LATEST=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | head -n1)
            if [[ -z "$LATEST" ]]; then
              SEMVER="0.1.0"
            else
              VER="${LATEST#v}"
              IFS='.' read -r MAJ MIN PAT <<< "$VER"
              SEMVER="${MAJ}.${MIN}.$((PAT + 1))"
            fi
            TAG="v${SEMVER}"
            TITLE="Pre-release ${TAG} · $(date -u '+%Y-%m-%d %H:%M UTC') · ${GITHUB_SHA::7}"
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          fi
          echo "tag=${TAG}"       >> "$GITHUB_OUTPUT"
          echo "semver=${SEMVER}" >> "$GITHUB_OUTPUT"
          echo "title=${TITLE}"   >> "$GITHUB_OUTPUT"

  # ── 1. Tests ─────────────────────────────────────────────────────────────────
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run tests
        run: dotnet test --configuration Release --verbosity normal

  # ── 2. Multi-platform Build ───────────────────────────────────────────────────
  build:
    name: Build · ${{ matrix.rid }}
    needs: test
    strategy:
      fail-fast: false   # let every target attempt even if one fails
      matrix:
        include:
          # ── Linux ─────────────────────────────────────────────────────────
          - { os: ubuntu-latest,  rid: linux-x64,         archive: tar }
          - { os: ubuntu-latest,  rid: linux-arm64,        archive: tar }
          - { os: ubuntu-latest,  rid: linux-musl-x64,     archive: tar }
          - { os: ubuntu-latest,  rid: linux-musl-arm64,   archive: tar }

          # ── Windows ───────────────────────────────────────────────────────
          - { os: windows-latest, rid: win-x64,            archive: zip }
          - { os: windows-latest, rid: win-x86,            archive: zip }
          - { os: windows-latest, rid: win-arm64,          archive: zip }

          # ── macOS ─────────────────────────────────────────────────────────
          - { os: macos-latest,   rid: osx-x64,            archive: tar }
          - { os: macos-latest,   rid: osx-arm64,          archive: tar }

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish — ${{ matrix.rid }}
        run: >-
          dotnet publish ${{ env.AVALONIA_PROJECT }}
          --configuration Release
          --runtime ${{ matrix.rid }}
          --self-contained true
          --output publish/${{ matrix.rid }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WallpaperMaker-${{ matrix.rid }}
          path: publish/${{ matrix.rid }}
          retention-days: 30

  # ── 3. GitHub Release ─────────────────────────────────────────────────────────
  #
  #  Downloads every build artifact, bundles each into a platform-appropriate
  #  archive, then publishes a GitHub Release using the auto-computed version:
  #    • tag push  → versioned release  (e.g. "Release v1.2.3")
  #    • main push → pre-release with bumped version (e.g. "Pre-release v1.2.4")
  #
  release:
    name: Create GitHub Release
    needs: [version, build]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Package release archives
        run: |
          mkdir -p release-assets
          for dir in artifacts/WallpaperMaker-*/; do
            name=$(basename "$dir")
            rid="${name#WallpaperMaker-}"
            if [[ "$rid" == win-* ]]; then
              # Windows users expect .zip
              (cd "$dir" && zip -r "../../release-assets/${name}.zip" .)
            else
              # Linux / macOS use .tar.gz
              tar -czf "release-assets/${name}.tar.gz" -C "$dir" .
            fi
          done
          echo "──── Release assets ────────────────────────────────"
          ls -lh release-assets/

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FLAGS="--generate-notes"
          [[ "${{ needs.version.outputs.prerelease }}" == "true" ]] && FLAGS="$FLAGS --prerelease"

          gh release create "${{ needs.version.outputs.tag }}" \
            --title "${{ needs.version.outputs.title }}" \
            $FLAGS \
            release-assets/*